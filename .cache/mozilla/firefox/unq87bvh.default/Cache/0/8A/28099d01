!function(){var libra_test_helpers_browser_globals_window,libra_id_utils_generateUUID,libra_url_utils_buildQueryString,libra_compat_cover_console_log,libra_logger_logger,aws_aws_namespace,target_util,target_feature_detects,libra_test_helpers_browser_globals_document,target_error,target_cookie_manager,target_data_cookie_facade,target_validator,target_parameter_fetcher,target_mbox_controller,target_mbox_base,target_target_request_data_builder,target_target_requester,target_page_mbox,target_language_helper,target_url_utils,target_aws_requester,target_mbox,target_mbox_create,target_mediator;!function(){libra_test_helpers_browser_globals_window=function(){return window}();libra_id_utils_generateUUID=function(){function generateUUID(){var d=(new Date).getTime();var uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c=="x"?r:r&3|8).toString(16)});return uuid}return generateUUID}();libra_url_utils_buildQueryString=function(window){function buildQueryString(params){var parts=[];for(var key in params){if(params.hasOwnProperty(key)){parts[parts.length]=encodeURIComponent(key)+"="+encodeURIComponent(params[key])}}return parts.join("&")}return buildQueryString}(libra_test_helpers_browser_globals_window);libra_compat_cover_console_log=function(){if(!window.console){console={log:function(){}}}return true}();libra_logger_logger=function(window,generateUUID,buildQueryString){var Logger=function(){var LOG_LEVELS={info:{warn:true,error:true},warn:{error:true},error:{},debug:{info:true,warn:true,error:true}};var LOG_ENDPOINT="https://fls-na.amazon.com/1/aws-mktg/1/OE/";var pageRequestId=null;function Logger(namespace,logLevel){this.namespace=namespace;this.logLevel=logLevel||this.getLogLevelByQueryString();this.pageRequestId=this.getPageRequestId()}Logger.prototype={constructor:Logger,logExternally:function(logLevel,msg,pageTime,customParams){var standardParams={cat:this.namespace,type:logLevel,msg:msg,pageTime:pageTime,pageRequestId:pageRequestId,page:window.location.toString()};var params=$.extend({},customParams,standardParams);var url=LOG_ENDPOINT+"?"+buildQueryString(params);setTimeout(function(){(new Image).src=url},0);this._lastImageUrl=url},getLogLevelByQueryString:function(){var level=this.getQueryStringParam("debug"+this.namespace);if(level===""){return null}else{return level}},getQueryStringParam:function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var re=new RegExp("[\\?&]"+name+"=([^&#]*)");var res=re.exec(window.location.search);if(res===null){return""}else{return decodeURIComponent(res[1].replace(/\+/g," "))}},getElapsedTimeSincePageLoad:function(){if("performance"in window&&"timing"in window.performance){return(new Date).getTime()-window.performance.timing.responseEnd}else{return-1}},getPageRequestId:function(){pageRequestId=pageRequestId||generateUUID();return pageRequestId},_endpoint:LOG_ENDPOINT};for(var level in LOG_LEVELS){if(LOG_LEVELS.hasOwnProperty(level)){!function(level){Logger.prototype[level]=function(msg,logExternally,customParams){var pageTime=this.getElapsedTimeSincePageLoad();var logLevelStr=level.toUpperCase();logExternally=logExternally||false;if(logExternally===true){this.logExternally(logLevelStr,msg,pageTime,customParams)}if(this.logLevel!==null){if(level===this.logLevel||LOG_LEVELS[this.logLevel].hasOwnProperty(level)){var out="["+logLevelStr+"]";if(logExternally===true){out+="[EXTERNAL]"}out+=" "+this.namespace+": "+msg+"; @"+pageTime+"ms";if(typeof customParams!=="undefined"){out+="; "+JSON.stringify(customParams)}console.log(out);this._lastConsoleLog=out}}}}(level)}}return Logger}();return Logger}(libra_test_helpers_browser_globals_window,libra_id_utils_generateUUID,libra_url_utils_buildQueryString);aws_aws_namespace=function(){AWS=typeof AWS==="object"?AWS:{};return AWS}();target_util=function(){var Util={generateRandomId:function(){return(new Date).getTime()+"-"+Math.floor(Math.random()*999999)}};return Util}();target_feature_detects=function(){var FeatureDetects={hasCORSSupport:function(){return"withCredentials"in new XMLHttpRequest}};return FeatureDetects}();libra_test_helpers_browser_globals_document=function(){return document}();target_error=function(){var TargetError=function(){function TargetError(message){var err=new Error(message);err.name="TargetError";this.message=err.message;if(err.stack){this.stack=err.stack}}var err=new Error;err.name="TargetError";TargetError.prototype=err;return TargetError}();return TargetError}();target_cookie_manager=function(document,TargetError){var CookieManager=function(){var defaults={domain:".amazon.com",path:"/",expireSeconds:86400};function CookieManager(name,options){var opts=$.parseJSON(JSON.stringify(defaults));for(var key in options){if(options.hasOwnProperty(key)){opts[key]=options[key]}}this.options=opts;this.name=name;this.exists=false;this.rawValue=null;this.value=null;if(window.location.hostname==="localhost"){this.options.domain=""}if(document.cookie.length&&document.cookie.indexOf(this.name)!==-1){this.exists=true}}CookieManager.prototype={constructor:CookieManager,write:function(){var expiresDate;if(typeof this.options.expireSeconds==="number"){expiresDate=new Date;expiresDate.setSeconds(expiresDate.getSeconds()+this.options.expireSeconds)}var ret=document.cookie=[this.name,"=",this.rawValue,expiresDate?"; expires="+expiresDate.toUTCString():"",this.options.path?"; path="+this.options.path:"",this.options.domain?"; domain="+this.options.domain:""].join("");if(ret){this.exists=true}return ret},read:function(){var found=false;if(document.cookie.length){var cookieStart=document.cookie.indexOf(this.name);if(cookieStart!==-1){found=true;var valueStart=cookieStart+this.name.length+1;var cookieEnd=document.cookie.indexOf(";",valueStart);if(cookieEnd===-1){cookieEnd=document.cookie.length}this.rawValue=document.cookie.substring(valueStart,cookieEnd)}}if(!found){this.exists=false}return found},remove:function(){this.options.expireSeconds=-1;var ret=this.write();if(ret){this.exists=false}return ret},encode:function(){this.rawValue=encodeURIComponent(this.value)},decode:function(){try{this.value=decodeURIComponent(this.rawValue)}catch(ex){throw new TargetError("CookieManagerDecodeError: Failed to decode cookie '"+this.name+"'")}},stringify:function(){try{this.rawValue=JSON.stringify(this.value);this.rawValue=encodeURIComponent(this.rawValue)}catch(ex){throw new TargetError("CookieManagerStringifyError: Failed to stringify cookie '"+this.name+"'")}},parse:function(){try{this.value=decodeURIComponent(this.rawValue);this.value=$.parseJSON(this.value)}catch(ex){throw new TargetError("CookieManagerParseError: Failed to parse cookie '"+this.name+"'")}}};return CookieManager}();return CookieManager}(libra_test_helpers_browser_globals_document,target_error);target_data_cookie_facade=function(Logger,CookieManager){var DataCookieFacade=function(){function DataCookieFacade(){this.logger=new Logger("TargetMediator");this.expireSeconds=33696e3;this.cookie=new CookieManager("aws-target-data",{expireSeconds:this.expireSeconds});this.values={};this.allowedKeys={support:null,campaignId:null,environmentId:null,mboxPage:null,mbox:null};this.read()}DataCookieFacade.prototype={constructor:DataCookieFacade,read:function(){try{this.cookie.read();if(this.cookie.rawValue!==null){this.cookie.parse();this.setValues(this.cookie.value)}}catch(ex){this.cookie.remove();this.logger.error("CorruptDataCookieError: "+ex.message,true)}},write:function(pairs){this.setValues(pairs);this.cookie.value=this.values;this.cookie.stringify();this.cookie.write()},setValues:function(pairs){for(var key in pairs){if(pairs.hasOwnProperty(key)){if(key in this.allowedKeys){if(typeof pairs[key]==="undefined"||pairs[key]===null){delete this.values[key]}else{this.values[key]=pairs[key]}}}}},hasCompleteParamsSet:function(){var requiredKeys=["campaignId","environmentId","mboxPage","mbox"];for(var i=0,len=requiredKeys.length;i<len;i++){if(!this.values[requiredKeys[i]]){return false}}return true}};return DataCookieFacade}();return DataCookieFacade}(libra_logger_logger,target_cookie_manager);target_validator=function(){var Validator={isValidVisitorId:function(str){var validVisitorIdRegexp=/^[0-9]{13}-[0-9]{1,6}(\.[0-9]{2}_[0-9]{2,3})?$/;return validVisitorIdRegexp.test(str)},isValidSessionId:function(str){var validSessionIdRegexp=/^[0-9]{13}-[0-9]{1,6}$/;return validSessionIdRegexp.test(str)}};return Validator}();target_parameter_fetcher=function(window,document,Logger,CookieManager,Util,Validator){var ParameterFetcher=function(){function ParameterFetcher(dataCookie){this.logger=new Logger("TargetMediator");this.dataCookie=dataCookie;this.mboxPageId=null;this.mboxXDomain=null;this.mboxNoRedirect=null;this.mboxHost=null;this.screenWidth=null;this.screenHeight=null;this.screenColorDepth=null;this.browserWidth=null;this.browserHeight=null;this.browserTimeOffset=null;this.currentUrl=null;this.referringUrl=null;this.registrationCookie=new CookieManager("regStatus");this.awsXMainCookie=new CookieManager("aws-x-main");this.sessionCookie=new CookieManager("aws-target-session-id",{expireSeconds:1800});this.visitorCookie=new CookieManager("aws-target-visitor-id",{expireSeconds:33696e3})}ParameterFetcher.prototype={constructor:ParameterFetcher,fetch:function(){this.mboxXDomain=this.getMboxXDomain();this.mboxNoRedirect=this.getMboxNoRedirect();this.mboxHost=this.getHostname();this.screenWidth=this.getScreenWidth();this.screenHeight=this.getScreenHeight();this.screenColorDepth=this.getScreenColorDepth();this.browserWidth=this.getBrowserWidth();this.browserHeight=this.getBrowserHeight();this.browserTimeOffset=this.getBrowserTimeOffset();this.currentUrl=this.getCurrentUrl();this.referringUrl=this.getReferringUrl();this.registrationStatus=this.getRegistrationStatus();this.hasAWSXMain=this.hasAWSXMainCookie();this.dataCookie.read();this.pageMboxName=this.getPageMboxName();this.mboxPageId=this.getMboxPageId();this.campaignId=this.getCampaignId();this.environmentId=this.getEnvironmentId();this.sessionCookie.read();this.getSessionId();this.visitorCookie.read();this.getVisitorId()},getClientParamsSet:function(){return{mboxPC:this.mboxPCId,mboxSession:this.mboxSessionId,mboxPage:this.mboxPageId,mboxXDomain:this.mboxXDomain,mboxNoRedirect:this.mboxNoRedirect,mboxHost:this.mboxHost,screenWidth:this.screenWidth,screenHeight:this.screenHeight,colorDepth:this.screenColorDepth,browserWidth:this.browserWidth,browserHeight:this.browserHeight,browserTimeOffset:this.browserTimeOffset,mboxUrl:this.currentUrl,mboxReferrer:this.referringUrl,registrationStatus:this.registrationStatus,hasAWSXMain:this.hasAWSXMain}},getServerParamsSet:function(){return{mboxPC:this.mboxPCId,mboxSession:this.mboxSessionId,mboxPage:this.mboxPageId,mboxXDomain:this.mboxXDomain,mboxNoRedirect:this.mboxNoRedirect,mboxHost:this.mboxHost,browserTimeOffset:this.browserTimeOffset,mboxUrl:this.currentUrl,mboxReferrer:this.referringUrl,registrationStatus:this.registrationStatus,hasAWSXMain:this.hasAWSXMain}},getPageMboxParamsSet:function(){return{pageMboxName:this.pageMboxName,campaignId:this.campaignId,environmentId:this.environmentId}},generateMboxPCId:function(){return Util.generateRandomId()},generateMboxSessionId:function(){return Util.generateRandomId()},getMboxPageId:function(){var val=this.dataCookie.values.mboxPage;if(typeof val==="undefined"||val===null||val===""){return Util.generateRandomId()}else{return val}},getMboxXDomain:function(){return"disabled"},getMboxNoRedirect:function(){return 1},getScreenWidth:function(){return window.screen.width},getScreenHeight:function(){return window.screen.height},getScreenColorDepth:function(){return window.screen.pixelDepth},getBrowserWidth:function(){return window.innerWidth?window.innerWidth:document.documentElement?document.documentElement.clientWidth:document.body.clientWidth},getBrowserHeight:function(){return window.innerHeight?window.innerHeight:document.documentElement?document.documentElement.clientHeight:document.body.clientHeight},getBrowserTimeOffset:function(){return-(new Date).getTimezoneOffset()},getCurrentUrl:function(){return window.location.toString()},getReferringUrl:function(){var referringUrl=document.referrer;if(referringUrl.length<2e3){return referringUrl}else{return""}},getHostname:function(){return window.location.hostname},getSessionId:function(){var regenerateId=false;if(this.sessionCookie.exists){try{this.sessionCookie.decode()}catch(ex){regenerateId=true;this.logger.error("UndecodableExistingSessionIdError",true,{sessionId:this.sessionCookie.rawValue})}if(!regenerateId){if(Validator.isValidSessionId(this.sessionCookie.value)){this.mboxSessionId=this.sessionCookie.value}else{regenerateId=true;this.logger.error("InvalidExistingSessionIdError",true,{sessionId:this.sessionCookie.value})}}}else{regenerateId=true;this.logger.debug("Cookie '"+this.sessionCookie.name+"' does not exist yet so create it")}if(regenerateId){this.mboxSessionId=this.generateMboxSessionId();this.sessionCookie.value=this.mboxSessionId;this.sessionCookie.encode()}this.sessionCookie.write()},getVisitorId:function(){var regenerateId=false;if(this.visitorCookie.exists){try{this.visitorCookie.decode()}catch(ex){regenerateId=true;this.logger.error("UndecodableExistingVisitorIdError",true,{visitorId:this.visitorCookie.rawValue})}if(!regenerateId){if(Validator.isValidVisitorId(this.visitorCookie.value)){this.mboxPCId=this.visitorCookie.value}else{regenerateId=true;this.logger.error("InvalidExistingVisitorIdError",true,{visitorId:this.visitorCookie.value})}}}else{regenerateId=true;this.logger.debug("Cookie '"+this.visitorCookie.name+"' does not exist yet so create it")}if(regenerateId){this.mboxPCId=this.generateMboxPCId();this.visitorCookie.value=this.mboxPCId;this.visitorCookie.encode()}this.visitorCookie.write()},getRegistrationStatus:function(){if(this.registrationCookie.exists){this.registrationCookie.read();var val=this.registrationCookie.rawValue;if(val==="registered"||val==="registering"){return val}}return"unregistered"},hasAWSXMainCookie:function(){return this.awsXMainCookie.exists.toString()},getPageMboxName:function(){return this.dataCookie.values.mbox},getCampaignId:function(){return this.dataCookie.values.campaignId},getEnvironmentId:function(){return this.dataCookie.values.environmentId}};return ParameterFetcher}();return ParameterFetcher}(libra_test_helpers_browser_globals_window,libra_test_helpers_browser_globals_document,libra_logger_logger,target_cookie_manager,target_util,target_validator);target_mbox_controller=function(document,Logger){var PENDING_STATE="pending";var logger=new Logger("TargetMediator");var MboxController={mboxRegistry:{},mboxClickRegistry:{},allMboxesResolved:function(){for(var name in this.mboxRegistry){if(this.mboxRegistry.hasOwnProperty(name)){if(this.mboxRegistry[name].state===PENDING_STATE){return false}}}return true},allClicksResolved:function(){for(var name in this.mboxClickRegistry){if(this.mboxClickRegistry.hasOwnProperty(name)){if(this.mboxClickRegistry[name].state===PENDING_STATE){return false}}}return true},hasEncounteredLastMbox:function(bool){if(bool===true){this._seenMboxLast=true}else{return this._seenMboxLast}},checkJqueryReadyHold:function(){if(this.allMboxesResolved()){$.holdReady(false);logger.debug("Release jQuery ready")}},hideAllMboxes:function(){document.write("<style>."+"js-mbox"+" { visibility:hidden; }</style>")},preventMboxCreation:function(){mboxCreate=function(){};mboxLast=function(){}},_seenMboxLast:false};return MboxController}(libra_test_helpers_browser_globals_document,libra_logger_logger);target_mbox_base=function(window,Logger,Util,MboxController){var RESOLVED_STATE="resolved";var logger=new Logger("TargetMediator");var MboxBase={getMboxTime:function(){var now=new Date;return now.getTime()-now.getTimezoneOffset()*6e4},getMboxTarget:function(){return this.campaignId+"."+this.environmentId},getMboxParamsSet:function(isClickRequest){var ret={mbox:this.name,mboxTime:this.time};if(isClickRequest){ret.mboxTarget=this.getMboxTarget();ret.mbox+="-clicked";ret.mboxTime=this.getMboxTime()}return ret},handleClickResponse:function(){MboxController.mboxClickRegistry[this.name]={state:RESOLVED_STATE};if(MboxController.allClicksResolved()){logger.debug("Go to click url "+this.clickUrl);window.location=this.clickUrl}else{logger.debug("All clicks not resolved yet")}},isReportableClickUrl:function(url,$a){if(typeof url!=="undefined"){if($a!==null&&$a.attr("data-mbox-ignore")==="true"){logger.debug("Click ignored");return false}return url!==""&&!/^(\#|javascript)/.test(url)}else{return false}}};return MboxBase}(libra_test_helpers_browser_globals_window,libra_logger_logger,target_util,target_mbox_controller);target_target_request_data_builder=function(buildQueryString,Util){var TargetRequestDataBuilder=function(){var ENDPOINT="https://amazonwebservicesinc.tt.omtrdc.net/m2/amazonwebservicesinc/ubox/raw";function TargetRequestDataBuilder(mboxParams,pageParams,isClickRequest){this.mboxParams=mboxParams;this.pageParams=pageParams;this.isClickRequest=isClickRequest;this.postParams=null;this.url=ENDPOINT;this.build()}TargetRequestDataBuilder.prototype={constructor:TargetRequestDataBuilder,build:function(){this.postParams={};for(var key in this.pageParams){if(this.pageParams.hasOwnProperty(key)){this.postParams[key]=this.pageParams[key]}}for(key in this.mboxParams){if(this.mboxParams.hasOwnProperty(key)){this.postParams[key]=this.mboxParams[key]}}this.url=this.url+"?"+buildQueryString({mboxPC:this.postParams.mboxPC,mboxSession:this.postParams.mboxSession,uniq:Util.generateRandomId()})},_endpoint:ENDPOINT};return TargetRequestDataBuilder}();return TargetRequestDataBuilder}(libra_url_utils_buildQueryString,target_util);target_target_requester=function(Logger){var TargetRequester=function(){var PENDING_STATE="pending";var RESOLVED_STATE="resolved";var REJECTED_STATE="rejected";var TIMEOUT_STATE="timeout";var TIMEOUT=6e3;var offerRegistry={};function TargetRequester(callback,targetRequestDataBuilder,isClickRequest){this.logger=new Logger("TargetMediator");this.callback=callback;this.url=targetRequestDataBuilder.url;this.postData=targetRequestDataBuilder.postParams;this.isClickRequest=isClickRequest;this.response=null;this.state=PENDING_STATE}TargetRequester.prototype={constructor:TargetRequester,fetch:function(){var that=this;this.requestStartTime=(new Date).getTime();var pr=$.ajax({type:"POST",url:this.url,data:this.postData,crossDomain:true,xhrFields:{withCredentials:false}}).done(function(data,textStatus,jqXHR){that.done.call(that,data,textStatus,jqXHR)}).fail(function(data,textStatus,jqXHR){that.fail.call(that,data,textStatus,jqXHR)});// if the the timeout limit has been exceeded
var pollForResponse=function(){if(pr.state()!=="pending"){return}var currentTime=(new Date).getTime();if(currentTime-that.requestStartTime>=TIMEOUT){that.state=TIMEOUT_STATE;pr.abort();return}var nextValue;setTimeout(nextValue=function(){return pollForResponse()},100);return nextValue};pollForResponse()},done:function(data,textStatus,jqXHR){this.logger.info("TargetRequester success for '"+this.postData.mbox+"' returned: "+data);this.logger.info("TargetRequesterXHRSuccess",true,{locationName:this.postData.mbox,requestStartTime:this.requestStartTime,isClickRequest:this.isClickRequest});this.processResponseData(data);this.callback(this.response,this.state)},fail:function(data,textStatus,jqXHR){if(this.state===TIMEOUT_STATE){this.logger.error("TargetRequesterTimeoutError",true,{locationName:this.postData.mbox,requestStartTime:this.requestStartTime,isClickRequest:this.isClickRequest})}else{this.logger.error("TargetRequesterXHRError: "+textStatus,true,{locationName:this.postData.mbox,requestStartTime:this.requestStartTime,isClickRequest:this.isClickRequest})}this.state=REJECTED_STATE;this.callback(this.response,this.state)},processResponseData:function(data){if(this.isClickRequest){this.state=RESOLVED_STATE}else if(this.isUnassociatedOffer(data)){this.logger.error("UnassociatedOfferError",true,{locationName:this.postData.mbox,isClickRequest:this.isClickRequest});this.state=REJECTED_STATE}else if(this.isValidRegularOffer(data)||this.isValidTransitionRegularOffer(data)){this.response=this.parseResponseData(data);if(this.response){if(this.isDuplicateOffer(this.response.url)){this.logger.error("DuplicateOfferError",true,{locationName:this.postData.mbox,isClickRequest:this.isClickRequest});this.state=REJECTED_STATE}else{offerRegistry[this.response.url]=true;this.state=RESOLVED_STATE}}else{this.state=REJECTED_STATE}}else if(this.isValidDefaultOffer(data)){this.response=this.parseResponseData(data);if(this.response){this.state=RESOLVED_STATE}else{this.state=REJECTED_STATE}}else if(this.isErrorOffer(data)){this.logger.error("TargetRequesterParameterError: "+data,true,{locationName:this.postData.mbox,isClickRequest:this.isClickRequest});this.state=REJECTED_STATE}else{this.logger.error("InvalidOfferError",true,{locationName:this.postData.mbox,isClickRequest:this.isClickRequest});this.state=REJECTED_STATE}},parseResponseData:function(data){try{return $.parseJSON(data)}catch(ex){this.logger.error("UnparsableOfferError",true,{locationName:this.postData.mbox,isClickRequest:this.isClickRequest});return{}}},isUnassociatedOffer:function(str){return str==="success"},isErrorOffer:function(str){var re=/^Mbox parameter \'(mbox|mboxTarget)\' not specified$/;return re.test(str)},isValidDefaultOffer:function(str){var validDefaultOfferRegexp=/^\{"defaultOffer":true,"campaignId":"[0-9]{1,40}","environmentId":"[0-9]{1,40}","userPCId":"[0-9\.\-_]{10,30}"\}$/;return validDefaultOfferRegexp.test(str)},isValidRegularOffer:function(str){var validRegularOfferRegexp=/^\{"url":"\/[a-z]{2}_[A-Z]{2}\/[a-zA-Z0-9\/_\.\-%\+\,\'\?\\#\$\&]+","campaignId":"[0-9]{1,40}","environmentId":"[0-9]{1,40}","userPCId":"[0-9\.\-_]{10,30}"\}$/;return validRegularOfferRegexp.test(str)},isValidTransitionRegularOffer:function(str){var validRegularOfferRegexp=/^\{"url":"https?:\/\/aws\.amazon\.com\/[a-zA-Z0-9\/_\.\-%\+\,\'\?\\#\$\&]*","campaignId":"[0-9]{1,40}","environmentId":"[0-9]{1,40}","userPCId":"[0-9\.\-_]{10,30}"\}$/;return validRegularOfferRegexp.test(str)},isDuplicateOffer:function(url){return url in offerRegistry}};return TargetRequester}();return TargetRequester}(libra_logger_logger);target_page_mbox=function(Logger,MboxBase,MboxController,TargetRequestDataBuilder,TargetRequester){var PageMbox=function(){var PENDING_STATE="pending";var RESOLVED_STATE="resolved";function PageMbox(pageMboxParams,serverParamsSet){$.extend(this,MboxBase);this.logger=new Logger("TargetMediator");this.name=pageMboxParams.pageMboxName;this.environmentId=pageMboxParams.environmentId;this.campaignId=pageMboxParams.campaignId;this.serverParamsSet=serverParamsSet;this.time=this.getMboxTime();MboxController.mboxRegistry[this.name]={state:RESOLVED_STATE,isPageMbox:true};this.logger.info("Instantiate page mbox '"+this.name+"'")}PageMbox.prototype={constructor:PageMbox,setClickHandler:function(){var that=this;$(document).on("click.aws-mbox",function(e){that.logger.debug("Page-clicked '"+that.name+"'");var $closestAnchor=$(e.target).closest("a");that.clickUrl=$closestAnchor.attr("href");if(that.isReportableClickUrl(that.clickUrl,$closestAnchor)){e.preventDefault();var targetRequestDataBuilder=new TargetRequestDataBuilder(that.getMboxParamsSet(true),that.serverParamsSet,true);var targetRequester=new TargetRequester($.proxy(that.handleClickResponse,that),targetRequestDataBuilder,true);MboxController.mboxClickRegistry[that.name]={state:PENDING_STATE};targetRequester.fetch()}})}};return PageMbox}();return PageMbox}(libra_logger_logger,target_mbox_base,target_mbox_controller,target_target_request_data_builder,target_target_requester);target_language_helper=function(window,Logger){var logger=new Logger("TargetMediator");var LanguageHelper={defaultLangShortcode:"en",pageLangShortcode:"en",supportedLangCodes:["en"],supportedLangCodesHash:null,langCodeMapping:{"en-US":"en","es-ES":"es","de-DE":"de","fr-FR":"fr","it-IT":"it","ja-JP":"jp","ko-KR":"ko","pt-BR":"pt","ru-RU":"ru","zh-CN":"cn","zh-TW":"tw"},getLongLangCodeByShortcode:function(shortcode){for(var key in this.langCodeMapping){if(this.langCodeMapping[key]===shortcode){return key}}return false},isSupportedMboxName:function(name){if(this.supportedLangCodesHash===null){this.makeSupportedLangCodesHash()}var underscorePart=name.substr(2,1);if(underscorePart==="_"){var codePart=name.substring(0,2);return codePart in this.supportedLangCodesHash}return false},isMboxNameMatchingPageLang:function(name){var codePart=name.substring(0,2);if(codePart===this.pageLangShortcode){return true}return false},isPageLangSupported:function(){if(this.supportedLangCodesHash===null){this.makeSupportedLangCodesHash()}return this.pageLangShortcode in this.supportedLangCodesHash},makeSupportedLangCodesHash:function(){this.supportedLangCodesHash={};for(var i=0,len=this.supportedLangCodes.length;i<len;i++){this.supportedLangCodesHash[this.supportedLangCodes[i]]=true}},determinePageLang:function(){var lang=this.getLangFromHTMLTag();if(lang===false){lang=this.getLangFromFragmentIdentifier()}if(lang===false){this.pageLangShortcode=null}else{this.pageLangShortcode=lang}},getLangFromHTMLTag:function(){var lang=$("html").attr("lang");if(typeof lang==="undefined"){logger.error("HTML tag lang attribute is undefined")}else{if(lang in this.langCodeMapping){return this.langCodeMapping[lang]}}return false},getLangFromFragmentIdentifier:function(){var hash=window.location.hash.slice(1);var parts=hash.split("=");if(parts[0]==="offerLang"&&parts.length>1){var lang=parts[1];if(lang in this.langCodeMapping){return this.langCodeMapping[lang]}}return false}};return LanguageHelper}(libra_test_helpers_browser_globals_window,libra_logger_logger);target_url_utils=function(window){var UrlUtils={replaceOrigin:function(url,origin){var re=/^https?:\/\/([^:\/\s]+)/;return url.replace(re,origin)},replaceOriginWithCurrent:function(url){var origin=window.location.protocol+"//"+window.location.host;return this.replaceOrigin(url,origin)}};return UrlUtils}(libra_test_helpers_browser_globals_window);target_aws_requester=function(window,Logger,UrlUtils,LanguageHelper){var AWSRequester=function(){var PENDING_STATE="pending";var RESOLVED_STATE="resolved";var REJECTED_STATE="rejected";var TIMEOUT_STATE="timeout";var TIMEOUT=4e3;var TargetMediator;function AWSRequester(callback,pTargetMediator){TargetMediator=pTargetMediator;this.logger=new Logger("TargetMediator");this.callback=callback;this.data=null;this.state=PENDING_STATE}AWSRequester.prototype={constructor:AWSRequester,fetch:function(){var that=this;this.requestStartTime=(new Date).getTime();var pr=$.ajax({type:"GET",url:this.url}).done(function(data,textStatus,jqXHR){that.done.call(that,data,textStatus,jqXHR)}).fail(function(data,textStatus,jqXHR){that.fail.call(that,data,textStatus,jqXHR)});// if the the timeout limit has been exceeded
var pollForResponse=function(){if(pr.state()!=="pending"){return}var currentTime=(new Date).getTime();if(currentTime-that.requestStartTime>=TIMEOUT){that.state=TIMEOUT_STATE;pr.abort();return}var nextValue;setTimeout(nextValue=function(){return pollForResponse()},100);return nextValue};pollForResponse()},done:function(data,textStatus,jqXHR){this.data=data;this.logger.info("AWSRequesterXHRSuccess",true,{offerUrl:this.url,requestStartTime:this.requestStartTime});this.state=RESOLVED_STATE;this.callback(this.data,this.state)},fail:function(data,textStatus,jqXHR){if(this.state===TIMEOUT_STATE){this.logger.error("AWSRequesterTimeoutError",true,{offerUrl:this.url,requestStartTime:this.requestStartTime})}else{this.logger.error("AWSRequesterXHRError: "+textStatus,true,{offerUrl:this.url,requestStartTime:this.requestStartTime})}this.state=REJECTED_STATE;this.callback(this.data,this.state)},setUrl:function(url){var isTransitionUrl=/^https?:\/\/aws\.amazon\.com\//.test(url);if(TargetMediator.options.offerOrigin==="/"){if(!isTransitionUrl){url="https://s0.awsstatic.com"+url}url=UrlUtils.replaceOriginWithCurrent(url)}else{if(isTransitionUrl){url=UrlUtils.replaceOrigin(url,TargetMediator.options.offerOrigin)}else{url=TargetMediator.options.offerOrigin+url}}url=this.appendUrlFileSuffix(url);url=this.appendUrlQueryString(url);url=this.prependUrlPathname(url);if(isTransitionUrl){var re=/\/[a-z]{2}\/s\//;var match=url.match(re);if(match!==null){var shortcode=match[0].substring(1,3);var longLangCode=LanguageHelper.getLongLangCodeByShortcode(shortcode);url=url.replace(re,"/"+longLangCode.replace("-","_")+"/")}else{url=url.replace(/\/s\//,"/en_US/")}}this.url=url},appendUrlFileSuffix:function(url){if(url.match(/\/$/g)){if(TargetMediator.options.offerFileSuffix==="/"){return url}else{return url.substr(0,url.length-1)+TargetMediator.options.offerFileSuffix}}else{return url+TargetMediator.options.offerFileSuffix}},appendUrlQueryString:function(url){return url+TargetMediator.options.offerQueryString},prependUrlPathname:function(url){if(TargetMediator.options.offerContentPath!==""){var indexOfProtocolEnd=url.indexOf("//");var indexOfPathname=url.indexOf("/",indexOfProtocolEnd+2);return url.substr(0,indexOfPathname)+TargetMediator.options.offerContentPath+url.substr(indexOfPathname,url.length)}return url}};return AWSRequester}();return AWSRequester}(libra_test_helpers_browser_globals_window,libra_logger_logger,target_url_utils,target_language_helper);target_mbox=function(Logger,MboxBase,MboxController,TargetRequestDataBuilder,TargetRequester,AWSRequester,CookieManager,Validator,LanguageHelper,Util,TargetError){var Mbox=function(){var PENDING_STATE="pending";var RESOLVED_STATE="resolved";var REJECTED_STATE="rejected";var TargetMediator;function Mbox($elem,pTargetMediator){$.extend(this,MboxBase);TargetMediator=pTargetMediator;this.logger=new Logger("TargetMediator");this.$elem=$elem;this.name=this.getName($elem);this.time=this.getMboxTime();this.logger.info("Instantiate mbox '"+this.name+"'");MboxController.mboxRegistry[this.name]={state:PENDING_STATE};this.targetRequestDataBuilder=new TargetRequestDataBuilder(this.getMboxParamsSet(false),TargetMediator.clientParamsSet,false);this.targetRequester=new TargetRequester($.proxy(this.handleOfferResponse,this),this.targetRequestDataBuilder,false);this.awsRequester=new AWSRequester($.proxy(this.handleContentResponse,this),TargetMediator)}Mbox.prototype={constructor:Mbox,fetch:function(){this.targetRequester.fetch()},handleOfferResponse:function(res,state){if(state===RESOLVED_STATE){this.updateVisitorId(res);this.environmentId=res.environmentId;this.campaignId=res.campaignId}if(state===RESOLVED_STATE&&typeof res.defaultOffer==="undefined"){MboxController.mboxRegistry[this.name].offerUrl=res.url;this.awsRequester.setUrl(res.url);this.awsRequester.fetch()}else if(state===RESOLVED_STATE&&typeof res.defaultOffer==="boolean"&&res.defaultOffer){MboxController.mboxRegistry[this.name].isDefault=true;this.showDefault(RESOLVED_STATE);this.setClickHandler()}else{this.showDefault(REJECTED_STATE)}},handleContentResponse:function(res,state){if(state===RESOLVED_STATE){var contentInjectionFailed=false;var $defaultElem=this.$elem.clone();try{this.$elem.html(res)}catch(ex){contentInjectionFailed=true;this.$elem.html($defaultElem.html());this.showDefault(REJECTED_STATE);this.logger.error("OfferInjectionError: "+ex.name+": "+ex.message,true,{locationName:this.name});throw new TargetError("OfferInjectionError: "+ex.name+": "+ex.message)}if(!contentInjectionFailed){this.showOffer(RESOLVED_STATE);this.setClickHandler()}}else{this.showDefault(REJECTED_STATE)}},setClickHandler:function(){var that=this;this.$elem.on("click.aws-mbox",function(e){that.logger.debug("Clicked '"+that.name+"'");var $closestAnchor=$(e.target).closest("a");var isClosestAnchorWithinMbox=!!$closestAnchor.parents(".js-mbox").length;if(isClosestAnchorWithinMbox){that.clickUrl=$closestAnchor.attr("href");if(that.isReportableClickUrl(that.clickUrl,$closestAnchor)){e.preventDefault();var targetRequestDataBuilder=new TargetRequestDataBuilder(that.getMboxParamsSet(true),TargetMediator.clientParamsSet,true);var targetRequester=new TargetRequester($.proxy(that.handleClickResponse,that),targetRequestDataBuilder,true);MboxController.mboxClickRegistry[that.name]={state:PENDING_STATE};targetRequester.fetch()}}})},getName:function($mbox){var name=$mbox.attr("data-mbox");this.validateName(name);if(name.indexOf(LanguageHelper.defaultLangShortcode)===0){var codePart=name.substring(2,name.length);name=LanguageHelper.pageLangShortcode+codePart}return name},validateName:function(name){if(typeof name==="undefined"){this.showDefault(REJECTED_STATE);throw new TargetError("MboxNameError: 'data-mbox' attribute is undefined")}if(name.length>250){this.showDefault(REJECTED_STATE);throw new TargetError("MboxNameError: '"+name+"' exceeds max length of 250 characters")}if(/\s+$/.test(name)){this.showDefault(REJECTED_STATE);throw new TargetError("MboxNameError: '"+name+"' has trailing whitespace")}if(name in MboxController.mboxRegistry){this.showDefault(REJECTED_STATE);throw new TargetError("MboxNameError: '"+name+"' is already registered in the current page")}if(!LanguageHelper.isSupportedMboxName(name)){this.showDefault(REJECTED_STATE);throw new TargetError("MboxNameError: '"+name+"' does not have a supported preceding locale code")}if(name.indexOf(LanguageHelper.defaultLangShortcode)!==0){if(!LanguageHelper.isMboxNameMatchingPageLang(name)){this.showDefault(REJECTED_STATE);throw new TargetError("MboxNameError: '"+name+"' is not in the current page language")}}},updateVisitorId:function(res){var visitorId=res.userPCId;if(TargetMediator.clientParamsSet.mboxPC!==visitorId){if(Validator.isValidVisitorId(visitorId)){TargetMediator.clientParamsSet.mboxPC=visitorId;TargetMediator.serverParamsSet.mboxPC=visitorId;var visitorCookie=new CookieManager("aws-target-visitor-id",{expireSeconds:33696e3});visitorCookie.value=visitorId;visitorCookie.encode();visitorCookie.write()}else{this.logger.error("InvalidVisitorIdFromTargetError",true,{visitorId:visitorId})}}},showDefault:function(state){this.show("default content",state)},showOffer:function(state){this.show("offer",state)},show:function(offerType,state){if(typeof this.name!=="undefined"){MboxController.mboxRegistry[this.name].state=state}if(MboxController.hasEncounteredLastMbox()){MboxController.checkJqueryReadyHold()}this.$elem[0].style.visibility="visible";this.logger.debug("Show "+offerType+" for '"+this.name+"' with state '"+state+"'")}};return Mbox}();return Mbox}(libra_logger_logger,target_mbox_base,target_mbox_controller,target_target_request_data_builder,target_target_requester,target_aws_requester,target_cookie_manager,target_validator,target_language_helper,target_util,target_error);target_mbox_create=function(Logger,Mbox,MboxController,TargetError){var logger=new Logger("TargetMediator");var locatorNodeCount=0;mboxCreate=function(){var locatorId="js-mbox-"+locatorNodeCount++;logger.debug("Create mbox locator '"+locatorId+"'");document.write('<div id="'+locatorId+'" style="visibility:hidden;display:none;">&nbsp;</div>');var locatorNode=document.getElementById(locatorId);var node=function(node){while(node!==null){if(node.nodeType===1){if((" "+node.className+" ").indexOf(" js-mbox ")>-1){return node}}node=node.previousSibling}return null}(locatorNode);if(node===null){document.write("<style>."+"js-mbox"+" { visibility:visible; }</style>");throw new TargetError("MboxCreateError: Failed to find an mbox at locator id "+locatorId)}var $elem=$(node);if($elem.length===0){document.write("<style>."+"js-mbox"+" { visibility:visible; }</style>");throw new TargetError("MboxCreateError: Failed to create a jQuery "+"object from mbox at locator id "+locatorId)}new Mbox($elem,AWS.TargetMediator).fetch()};mboxLast=function(){logger.debug("Seen mboxLast");MboxController.hasEncounteredLastMbox(true);MboxController.checkJqueryReadyHold()};return true}(libra_logger_logger,target_mbox,target_mbox_controller,target_error);target_mediator=function(Logger,AWS,Util,FeatureDetects,CookieManager,DataCookieFacade,ParameterFetcher,MboxController,PageMbox,LanguageHelper,MboxCreate){var logger=new Logger("TargetMediator");var TargetMediator={init:function(){var configOptions=typeof AWS.TargetMediator!=="undefined"?AWS.TargetMediator:{};this.options=$.extend({},this.defaults,configOptions);var isValidPageMbox=false;var dataCookie=new DataCookieFacade;if(dataCookie.hasCompleteParamsSet()){isValidPageMbox=true}else{logger.debug("Invalid data cookie. Not handling clicks for a page test.");isValidPageMbox=false}var staticCookie=new CookieManager("aws-target-static-id",{expireSeconds:31536e4});if(!staticCookie.exists){staticCookie.value=Util.generateRandomId();staticCookie.encode();staticCookie.write()}var parameterFetcher=new ParameterFetcher(dataCookie);parameterFetcher.fetch();TargetMediator.clientParamsSet=parameterFetcher.getClientParamsSet();TargetMediator.serverParamsSet=parameterFetcher.getServerParamsSet();var hasCORSSupport=FeatureDetects.hasCORSSupport();dataCookie.write({support:(+hasCORSSupport).toString(),campaignId:null,environmentId:null,mboxPage:null,mbox:null});if(!hasCORSSupport){MboxController.preventMboxCreation();logger.error("Mboxes not initialized because CORS is not supported");return}LanguageHelper.supportedLangCodes=this.options.supportedLanguages;LanguageHelper.determinePageLang();if(!LanguageHelper.isPageLangSupported()){MboxController.preventMboxCreation();logger.error("Mboxes not initialized because the page lang is not supported");return}MboxController.hideAllMboxes();$.holdReady(true);if(isValidPageMbox){var pageMbox=new PageMbox(parameterFetcher.getPageMboxParamsSet(),TargetMediator.serverParamsSet);pageMbox.setClickHandler()}},clientParamsSet:{},serverParamsSet:{},MboxController:MboxController,defaults:{defaultLangShortcode:"en",supportedLanguages:["en"],offerFileSuffix:"/index.html",offerContentPath:"",offerQueryString:"",offerOrigin:"https://s0.awsstatic.com"}};TargetMediator.init();AWS.TargetMediator=TargetMediator;return TargetMediator}(libra_logger_logger,aws_aws_namespace,target_util,target_feature_detects,target_cookie_manager,target_data_cookie_facade,target_parameter_fetcher,target_mbox_controller,target_page_mbox,target_language_helper,target_mbox_create)}()}();